<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Storage V2+ DApp ‚Äì Public Guest-Book & Tip-Jar</title>
  <style>
    :root {
      --primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --primary solidarity: #667eea;
      --error:bg: #f8d7da;
      --error:text: #721c24;
      --warning:bg: #fff3cd;
      --warning:text: #856404;
      --info:bg: #d1ecf1;
      --info:text: #0c5460;
      --success.bg: #d4edda;
      --success.text: #155724;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{background:var(--primary);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",.system-ui,"Apple Color Emoji","Segoe UI Emoji",sans-serif;min-height:100vh;padding:20px}
    .container{max-width:920px;margin:auto;background:#fff;border-radius:15px;overflow:hidden;box-shadow:0 0 40px rgba(0,0,0,0.07)}
    .header{background:var(--primary);padding:30px;color:#fff;text-align:center}
    .header h1{font-size:2.2em}
    .content,.section,.info-item,.event-item{
      border-radius:10px}
    .section{background:#f8f9fa;padding:20px;margin-bottom:20px;border-left:3px solid var(--primary solidarity)}
    .wallet-buttons{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:20px}
    .wallet-btn{padding:9px 15px;border-radius:8px;background:#fff;color:#555;border:1px solid #ddd}
    .wallet-btn:hover{box-shadow:0 2px 8px rgba(0,0,0,.08)}
    input{width:100%;padding:12px 15px;border:1px solid #ddd;border-radius:8px;font-size:15px;margin-bottom:15px}
    button{background:var(--primary);color:#fff;border:none;padding:12px 25px;border-radius:8px;font-size:14px;cursor:pointer}
    button:hover{box-shadow:0 5px 15px rgba(100,120,200,0.3);transform:translateY(-1px)}
    button:disabled{opacity:0.7;cursor:not-allowed}
    [contenteditable="true"] {
      border: 1px solid #ccc;
      padding: 10px;
      min-height: 3rem;
      outline: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Storage V2+</h1>
      <p style="font-size:1.1em">Decentralized guestbook + owner storage + tip-jar.</p>
    </div>

    <div class="content">

      <!-- 1. Connect section -->
      <div class="section">
        <div style="margin-bottom:20px">
          <div><strong>Full contract address</strong><br>
            <span id="contractAddr" class="monospace"></span>
          </div>
        </div>

        <div class="wallet-buttons">
          <button class="wallet-btn" onclick="connectWallet('auto')">
            <img width="18px" src="https://cdn.jsdelivr.net/npm/cryptocurrency-icons@0.38.0/svg/icon/eth.svg" /> Connect Wallet
          </button>
        </div>
      </div>

      <!-- 2. Core features -->
      <div class="section" id="featuresSection" style="display:none">

        <!-- Owner-only -->
        <div class="section" style="background:#f0f7ff">
          <h2>Storage Functions (Owner Only)</h2>
          <input id="storeInput" placeholder="eg. 3693">
          <button id="storeBtn" onclick="storeValue()">Store Number</button>
        </div>

        <!-- Public -->
        <div class="section" style="background:#fff">
          <div>
            <h2>üìù Public Guestbook</h2>
            <div contenteditable="true" id="guestMessage" name="guestMessage" placeholder="Type your message..." style="min-height:4rem;padding:1rem"></div>
            <button id="guestBtn" onclick="signGuestbook()" disabled>‚úçÔ∏è Sign Guestbook</button>
          </div>
          <div id="guestList" style="margin-top:20px"></div>
        </div>

        <div class="section" style="background:#ffe2e5">
          <h2>‚òï Tip-Jar</h2>
          <input id="tipAmount" placeholder="ETH amount (e.g. 0.001)">
          <button id="tipBtn" onclick="sendTip()" disabled>üí∏ Send Tip</button>
        </div>

        <!-- Admin -->
        <div class="section" style="background:#f0f7ff">
          <h2>Owner Tools</h2>
          <input id="newOwnerInput" placeholder="0x‚Ä¶">
          <button onclick="transferOwnership()" id="transferBtn" disabled>üè∑Ô∏è Transfer Ownership</button>
        </div>

      </div>

    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2"></script>
  <script>
    // Configuration
    const CONTRACT_ADDRESS = "0x30bDe02387EA7967b8C75a5189a1b2A61F8F4e22"; // Replace with your contract
    const GIWA_CHAIN_ID = 91342;
    const ABI = [
      // Storage features
      "function store(uint256 num)",
      "function retrieve() view returns (uint256)",
      "function transferOwnership(address newOwner)",
      // Guestbook features
      "function signGuestbook(string calldata message)",
      "function getGuestbookEntry(uint256 idx) view returns (string memory)",
      "function getGuestbookLength() view returns (uint256)",
      // Tip features
      "function withdrawTips()",
      // Viewers
      "event NumberStored(uint256 newValue, address setter, uint256 timestamp)",
      "event GuestbookSigned(address from, string message, uint256 timestamp)"
    ];

    // UI State
    let provider, signer, contract, accountAddress;

    // Connect wallet
    async function connectWallet() {
      if (window.ethereum) {
        try {
          provider = new ethers.providers.Web3Provider(window.ethereum);
          const net = await provider.getNetwork();

          // Check network
          if (net.chainId !== GIWA_CHAIN_ID) {
            alert(`Please switch to GIWA Sepolia Testnet (Chain ID: ${GIWA_CHAIN_ID})`);
            return;
          }

          // Connect wallet
          const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
          accountAddress = ethers.utils.getAddress(accounts[0]);
          signer = provider.getSigner();

          // Setup contract
          contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);

          // Update UI
          document.getElementById('contractAddr').textContent = CONTRACT_ADDRESS;
          document.getElementById('featuresSection').style.display = "block";
          loadGuestbook();
        }
        catch (err) {
          console.error(err);
          alert(err.message || 'Error connecting wallet');
        }
      } else {
        alert('Ethereum provider not detected');
      }
    }

    // Store number (owner only)
    async function storeValue() {
      const value = document.getElementById("storeInput").value.trim();

      try {
        if (!contract) throw Error("Connect wallet first");

        // Optional: Check if user is contract owner
        const owner = await contract.callStatic.owner();
        if (owner.toLowerCase() !== accountAddress.toLowerCase()) {
          throw Error("Only contract owner can store values");
        }

        // Perform transaction
        const tx = await contract.store(ethers.BigNumber.from(value));
        await tx.wait();
        alert("Transaction confirmed");
      }
      catch (err) {
        alert(err.message || "Transaction failed");
      }
    }

    // Guestbook functions
    async function signGuestbook() {
      const message = document.getElementById('guestMessage').innerText.trim();

      if (!message.length) {
        alert("Please enter a message");
        return;
      }

      try {
        const tx = await contract.signGuestbook(message);
        await tx.wait();
        alert("Your message was saved on-chain!");
        document.getElementById('guestMessage').innerText = '';
        await loadGuestbook();
      }
      catch (err) {
        alert(`Error: ${err.message}`);
      }
    }

    async function loadGuestbook() {
      try {
        const length = await contract.getGuestbookLength();
        let html = "<h3>Latest Messages</h3>";

        for (let i = length-1; i > length-1-5 && i >= 0; i--) { // Show last 5 messages
          const message = await contract.getGuestbookEntry(i);
          html += "<div style='border:1px solid #eee;padding: 0.8rem;'>" + message + "</div>";
        }

        document.getElementById('guestList').innerHTML = html;
      }
      catch { /* Ignore errors - might happen if not connected */ }
    }

    // Tip function
    async function sendTip() {
      const amount = document.getElementById('tipAmount').value.trim();

      if (!amount || isNaN(amount) || Number(amount) <= 0) {
        alert("Enter a valid ETH amount");
        return;
      }

      try {
        // Send ETH directly to contract acct
        const tx = await signer.sendTransaction({
          to: CONTRACT_ADDRESS,
          value: ethers.utils.parseEther(amount)
        });

        alert(`Tip sent! TxID: ${tx.hash}`);
      }
      catch (err) {
        alert("Error sending tip: " + err.message);
      }
    }

    // Initialize UI
    document.addEventListener('DOMContentLoaded', async () => {
      document.getElementById('contractAddr').textContent = CONTRACT_ADDRESS;
    });
  </script>
</body>
</html>
